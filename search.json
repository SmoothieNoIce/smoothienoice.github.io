[{"title":"srlabs/Certiception å®‰è£æ•™å­¸","url":"/2024/07/23/2024-07-23-Certiception/","content":"\nç™½çš®æ›¸: â€œ[*Certified Pre-Owned: Abusing Active Directory Certificate Services](https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf)â€*\n\n[https://tttang.com/archive/1593/#toc_061-misconfigured-certificate-templates-esc1](https://tttang.com/archive/1593/#toc_061-misconfigured-certificate-templates-esc1)\n\n# Certiception\n\nReference:\n\n- [https://www.gss.com.tw/blog/ansible-5](https://www.gss.com.tw/blog/ansible-5)\n- [https://medium.com/ianyc/ansible-windowsé€£ç·šè¨­å®š-basic-certificate-authentication-6750611d3764](https://medium.com/ianyc/ansible-windows%E9%80%A3%E7%B7%9A%E8%A8%AD%E5%AE%9A-basic-certificate-authentication-6750611d3764)\n\næœ¬å°ˆæ¡ˆä½¿ç”¨ Ansibleï¼Œéœ€è¦ä¸€å° linux çš„ controller åŠä¸€å°è¢«æ“ä½œçš„ windows server\n\n1. windows å®‰è£ winrm\n    - å¯æ–¼[é€£çµ](https://docs.ansible.com/ansible/latest/os_guide/windows_setup.html#winrm-listener)ä¸‹è¼‰ powershell script æª”ï¼Œç„¶å¾Œåœ¨éœ€è¦è¢«å®‰è£çš„ windows host ä¸ŠåŸ·è¡Œå®‰è£ winrm\n2. è¨­å®š Certiception\n    - åœ¨ controller ä¸Šä¸‹è¼‰\n        \n        [https://github.com/srlabs/Certiception](https://github.com/srlabs/Certiception)\n        \n    - å®‰è£ ansible\n        \n        [https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html](https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html)\n        \n        ```jsx\n        $ python3 -m pip install --user ansible\n        ```\n        \n3. åœ¨ windows å»ºç«‹ Enterprise Admin account\n    - å‰µå»ºåç¨±ç‚º `Vagrant` çš„ `Enterprise Admin account`ï¼Œä¸¦æ ¹æ“šè³‡æ–™åœ¨ controller å…§ç·¨è¼¯å°ˆæ¡ˆè£¡é¢çš„ inventory.yml\n    \n    <aside>\n    ğŸ’¡ å‰µå»º Vagrant EA çš„æˆªåœ–ï¼Œéœ€è¦åœ¨å‰µå»º User å®Œå¾ŒåŠ é€² Group å…§\n    \n    ![Untitled](Untitled%203.png)\n    \n    </aside>\n    \n    <aside>\n    ğŸ’¡ å‰µå»º Enterprise Admin account æ™‚ï¼Œå¦‚æœé‡åˆ°å¯†ç¢¼ä¸ç¬¦åˆæ™‚ï¼Œå¯ä¿®æ”¹ policy\n    \n    ![Untitled](Untitled%204.png)\n    \n    ![Untitled](Untitled%205.png)\n    \n    ![Untitled](Untitled%206.png)\n    \n    </aside>\n    \n4. åŸ·è¡Œ Ansible æŒ‡ä»¤\n    \n    <aside>\n    ğŸ’¡ å®‰è£å‰è¦æ³¨æ„ä¸èƒ½æœ‰ ADCSï¼Œå› ç‚º ansible æœƒå¹«ä½ è£å¥½\n    \n    </aside>\n    \n    ```bash\n    ansible-playbook -i inventory.yml playbooks/certiception.yml -vvv\n    ```\n    \n    <aside>\n    ğŸ’¡ Please provide the password for the configured Enterprise Admin account (needed to register the new CA):\n    ç‚º Vagrant çš„å¯†ç¢¼\n    \n    </aside>\n    \n    <aside>\n    ğŸ’¡ Please provide the password for the become user (local admin) on the honeypot CA server\n    ç‚º local admin(Administrator)çš„å¯†ç¢¼\n    \n    </aside>\n    \n    ![Untitled](Untitled%207.png)\n    \n    å¦‚æœæ²’é‡åˆ°éŒ¯èª¤å°±æ˜¯å®‰è£æˆåŠŸ\n    \n    <aside>\n    ğŸ’¡ Exception calling \"CreateProcessAsUser\" with \"9\" argument(s): \"Failed to logon [Vagrant@speed.cs.nycu.edu.tw](mailto:Vagrant@speed.cs.nycu.edu.tw) (Logon failure: the user has not been granted the requested logon type at this computer, Win32ErrorCode 1385 - 0x00000569)\"\n    \n    è§£: è¨­å®šé€™å…©å€‹ GPO \n    \n    ![Untitled](Untitled%208.png)\n    \n    ![Untitled](Untitled%209.png)\n    \n    </aside>\n    \n5. ç¢ºèª ESC1HoneypotTemplate Template æ˜¯å¦è¢«å®‰è£\n    \n    ![Untitled](Untitled%2010.png)\n    \n    <aside>\n    ğŸ’¡ å¦‚æœæ²’æœ‰å¯ä»¥è©¦è©¦æ‰‹å‹• issue\n    \n    ![Untitled](Untitled%2011.png)\n    \n    ![Untitled](Untitled%2012.png)\n    \n    </aside>\n    \n6. è§€å¯Ÿ Bloodhound\n    - åœ¨é¶æ©Ÿä¸Šä½¿ç”¨ Sharphound ä¾†é€²è¡Œ AD graph è’é›†ï¼Œç„¶å¾ŒåŒ¯å…¥æ–°ç‰ˆçš„ Bloodhound\n    - å¯ä»¥è§€å¯Ÿåˆ° ADCSESC1 é€™æ¢å‡ Edge å·²ç¶“å‡ºç¾åœ¨ Bloodhound å…§\n        \n        ![Untitled](Untitled%2013.png)\n        \n7. ä½¿ç”¨ Certify é€²è¡Œç¢ºèª\n    - åœ¨é¶æ©Ÿä¸Šä½¿ç”¨ Certifyï¼Œä¸¦ç¢ºèªè­‰æ›¸\n        \n        ```jsx\n        Certify.exe find /vulnerable\n        ```\n        \n        ![Untitled](Untitled%2014.png)\n        \n    - ä½¿ç”¨ Certify è«‹æ±‚è­‰æ›¸ï¼Œå¦‚æœ CA Response ç‚º Denied by Policy Module è¡¨ç¤ºæˆåŠŸå®‰è£\n        \n        ![Untitled](Untitled%2015.png)\n        \n    ğŸ’¡ å¯ç”¨ **certutil.exe æ‰¾åˆ° ca-name**\n    \n\n## Certiception åŸç†\n\n1. Certiception æœƒå¹«ä½ è‡ªå‹•å‰µå¥½ä¸€å€‹ CAï¼Œä½†ä¸€å€‹ Domain å…§åªæœ‰ä¸€å€‹ CAï¼Œæ‰€ä»¥ä¸èƒ½å…ˆæœ‰ ADCS\n2. ESC1HoneypotTemplate ç¢ºå¯¦æ˜¯æ˜“å—æ”»æ“Šçš„è­‰æ›¸ï¼Œä½†ä½¿ç”¨ TameMyCerts ä¾†é˜»æ­¢è­‰æ›¸ç™¼æ”¾\n- å› ç‚º ESC1 ä¸»è¦æ˜¯åˆ©ç”¨ SANï¼Œè€Œ TameMyCerts åµæ¸¬åˆ° request åŒ…å« SAN æ™‚å°±æœƒå–æ¶ˆ\n    \n    ![è¢å¹•æ“·å–ç•«é¢ 2024-07-22 220539.png](Untitled%2016.png)\n    \n3. å°ˆæ¡ˆä¸­ä½¿ç”¨ `ADCSTemplate` ä¾†å‰µå»º Templateï¼Œç„¶å¾Œè‡ªå‹•ç™¼æ”¾ ESC1HoneypotTemplate\n\n\n# **ESC1**\n\n- Misconfigured Certificate Templates - ESC1\n\næ†‘è­‰ç¯„æœ¬æœ‰ä¸€çµ„ç‰¹å®šçš„è¨­ç½®ï¼Œä½¿å®ƒå€‘æ¥µæ˜“è¢«æ”»æ“Šè€…åˆ©ç”¨ï¼Œä»¥å¯¦ç¾ç¶²åŸŸæ¬Šé™æå‡ã€‚ä¸‹é¢æˆ‘å€‘ä¾†ä»‹ç´¹ç¬¬ä¸€ç¨®é…ç½®æƒ…æ³ï¼ˆESC1ï¼‰ï¼š\n\n1. Enterprise CA æˆäºˆä½ç‰¹æ¬Šä½¿ç”¨è€…è¨»å†Šæ¬Šé™\n2. Manager approval è¢«ç¦ç”¨\n3. ç„¡éœ€æˆæ¬Šç°½å\n4. éæ–¼å¯¬é¬†çš„æ†‘è­‰ç¯„æœ¬å®‰å…¨æè¿°ç¬¦æœƒæˆäºˆä½ç‰¹æ¬Šä½¿ç”¨è€…æ†‘è­‰è¨»å†Šæ¬Šé™ã€‚\n5. æ†‘è­‰ç¯„æœ¬å®šç¾©äº†å•Ÿç”¨ç¶²åŸŸé©—è­‰çš„ EKUã€‚\n6. æ†‘è­‰ç¯„æœ¬å…è¨±è«‹æ±‚è€…åœ¨ CSR ä¸­æŒ‡å®š subjectAltName\n    - é€™è£¡ä¸»è¦é—œæ³¨åˆ°æœ€å¾Œä¸€å€‹é…ç½®æ¢ä»¶ã€‚å›æƒ³ä¸€ä¸‹ï¼Œåœ¨ AD é©—è­‰æœŸé–“ï¼ŒAD å°‡ä½¿ç”¨æ†‘è­‰çš„ subjectAltNameï¼ˆSANï¼‰æ¬„ä½æŒ‡å®šèº«åˆ†ã€‚å› æ­¤ï¼Œå¦‚æœè«‹æ±‚è€…å¯ä»¥åœ¨ CSR ä¸­æŒ‡å®š SANï¼Œå‰‡è«‹æ±‚è€…å¯ä»¥ä»¥ä»»ä½•äººï¼ˆä¾‹å¦‚ï¼Œç¶²åŸŸç®¡ç†å“¡ä½¿ç”¨è€…ï¼‰çš„èº«åˆ†è¦æ±‚æ†‘è­‰ã€‚æ†‘è­‰ç¯„æœ¬åœ¨å…¶ AD ç‰©ä»¶çš„ mspki-certificate-name-flag å±¬æ€§ä¸­æŒ‡å®šè«‹æ±‚è€…æ˜¯å¦å¯ä»¥åœ¨å…¶ä¸­æŒ‡å®š SANã€‚ mspki-certificate-name-flag å±¬æ€§æ˜¯ä½å…ƒæ©ç¢¼ï¼Œå¦‚æœå­˜åœ¨ CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT æ¨™èªŒï¼Œå‰‡è«‹æ±‚è€…å¯ä»¥æŒ‡å®š SANã€‚åœ¨æ†‘è­‰ç¯„æœ¬æ§åˆ¶å° MMC ç®¡ç†å–®å…ƒä¸­ï¼Œæ­¤å€¼åœ¨ç¯„æœ¬çš„ â€œå±¬æ€§â€ çš„ â€œä½¿ç”¨è€…åç¨±â€ æ¨™ç±¤ä¸­é€²è¡Œè¨­ç½®ï¼Œå¦‚ä¸‹åœ–æ‰€ç¤ºï¼Œå‹¾é¸ â€œåœ¨è¦æ±‚ä¸­æä¾›(S)â€ å³å¯ã€‚\n        \n        ![Untitled](Untitled%201.png)\n        \n        ![Untitled](Untitled%202.png)\n        ","tags":["Active Directory","ADCS"],"categories":["Active Directory"]},{"title":"ä½¿ç”¨Laravel Sanctumå¯¦ä½œè¨»å†Šç™»å…¥ç™»å‡º","url":"/2021/01/25/2021-01-25-ä½¿ç”¨Laravel_Sanctumå¯¦ä½œè¨»å†Šç™»å…¥ç™»å‡º/","content":"\nLaravel 7æ–°å¢äº†Sanctumè®“ç™»å…¥é©—è­‰æµç¨‹æ›´åŠ æ–¹ä¾¿ï¼ŒSanctumä¸åƒpassportè¦ç”¨åˆ°Oath2ï¼Œè€Œç°¡åŒ–äº†è¨±å¤šåŠŸèƒ½ã€‚æ¯”èµ·passportï¼Œå°æ‡‰ç”¨æˆ–SPAæ›´åŠ é©åˆä½¿ç”¨Sanctum\n\n### æº–å‚™\n\nå®‰è£sanctum\n``` bash\ncomposer require laravel/sanctum\n```\n\nç™¼ä½ˆè¨­å®šæª”\n``` bash\nphp artisan vendor:publish --provider=\"Laravel\\Sanctum\\SanctumServiceProvider\"\n```\n\nå»ºç«‹è³‡æ–™åº«\n``` bash\nphp artisan migrate\n```\n\n### Middlewareè¨­å®š\n\næˆ‘å€‘è¦çµ¦Apiè¨­å®šMiddlewareæ‰èƒ½è·‘ç™»å…¥æµç¨‹ï¼Œæ‹¿å–ä½¿ç”¨è€…è³‡æ–™\n\n``` php\n//app/Http/Kernel.php\nuse Laravel\\Sanctum\\Http\\Middleware\\EnsureFrontendRequestsAreStateful;\n\n'api' => [\n    EnsureFrontendRequestsAreStateful::class,\n    'throttle:60,1',\n    \\Illuminate\\Routing\\Middleware\\SubstituteBindings::class,\n],\n```\n\n### è¨»å†Š\n\n``` php\npublic function signUp(Request $request){\n    //é©—è­‰è³‡æ–™\n    $request->validate([\n        'name' => 'required',\n        'email' => 'required|email',\n        'password' => 'required',\n    ]);\n\n    //æŸ¥è©¢æ˜¯å¦å­˜åœ¨\n    $user = User::where('email', $request->email)->first();\n    if ($user != null) {\n        $data = [\n            \"method\" => \"sign up\",\n            \"message\" => \"already sign\",\n        ];\n        return response()->json($data, 401);\n    }\n\n    //å»ºç«‹å¸³æˆ¶\n    $user = User::create([\n        'sign_up_date' => date('Y-m-d'),\n        'name' => $request['name'],\n        'email' => $request['email'],\n        'password' => bcrypt($request['password']),\n    ]);\n\n    if ($user != null) {\n        $data = [\n            \"method\" => \"sign up\",\n            \"message\" => \"success\",\n        ];\n        return response()->json($data, 200);\n    } else {\n        $data = [\n            \"method\" => \"sign up\",\n            \"message\" => \"unexpected error\",\n        ];\n        return response()->json($data, 500);\n    }\n}\n```\n\n### ç™»å…¥\n\n``` php\npublic function getToken(Request $request){\n    //é©—è­‰è³‡æ–™\n    $request->validate([\n        'email' => 'required|email',\n        'password' => 'required',\n        'device_name' => 'required'\n    ]);\n\n    $user = User::where('email', $request->email)->first();\n\n    if (!$user || !Hash::check($request->password, $user->password)) {\n        $data = [\n            \"method\" => \"login\",\n            \"message\" => \"failed\",\n            \"data\" => [\n                \"access_token\" => \"\",\n                \"user_name\" => \"\",\n            ]\n        ];\n        return response()->json($data, 401);\n    } else {\n        $data = [\n            \"method\" => \"login\",\n            \"status_code\" => \"200\",\n            \"message\" => \"success\",\n            \"data\" => [\n                \"access_token\" => $user->createToken($request->device_name)->plainTextToken,\n                \"user_name\" => $user->name,\n            ]\n        ];\n        return response()->json($data, 200);\n    }\n}\n```\n\n### ç™»å‡º\n\n``` php\npublic function deleteToken(Request $request){\n    $request->user()->tokens()->where('name', $request->device_name)->delete();\n}\n```\n\nå¦‚æœä½¿ç”¨Vueçš„è©±ï¼Œå¯ä½¿ç”¨Vuexå„²å­˜tokenå’Œä¸æ©Ÿå¯†çš„ä½¿ç”¨è€…è³‡æ–™ï¼Œä¹Ÿå¯ç‚ºtokenè¨­å®šç¯„åœï¼Œå€åˆ†ç®¡ç†è€…å’Œç”¨æˆ¶çš„æ¬Šé™ã€‚","tags":["Laravel","Vue","Sanctum"],"categories":["Laravel"]}]